<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockMind ‚Äî AI Investor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        dark: {
                            50: '#f8fafc',
                            100: '#e2e8f0',
                            200: '#cbd5e1',
                            300: '#94a3b8',
                            400: '#64748b',
                            500: '#475569',
                            600: '#1e2030',
                            700: '#181a2a',
                            800: '#12141f',
                            900: '#0c0e16',
                        },
                        accent: {
                            green: '#22c55e',
                            red: '#ef4444',
                            blue: '#3b82f6',
                            purple: '#a855f7',
                            amber: '#f59e0b',
                            cyan: '#06b6d4',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        * { scrollbar-width: thin; scrollbar-color: #1e2030 #0c0e16; }
        *::-webkit-scrollbar { width: 6px; }
        *::-webkit-scrollbar-track { background: #0c0e16; }
        *::-webkit-scrollbar-thumb { background: #1e2030; border-radius: 3px; }
        
        body { background: #0c0e16; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        
        .thought-enter { animation: thoughtSlide 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes thoughtSlide {
            from { opacity: 0; transform: translateY(12px) scale(0.97); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .pulse-dot { animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }

        .gradient-border {
            background: linear-gradient(135deg, #1e2030, #181a2a);
            border: 1px solid rgba(255,255,255,0.06);
        }

        .glow-green { box-shadow: 0 0 20px rgba(34, 197, 94, 0.15); }
        .glow-red { box-shadow: 0 0 20px rgba(239, 68, 68, 0.15); }

        .thought-bubble {
            background: linear-gradient(135deg, rgba(30, 32, 48, 0.8), rgba(24, 26, 42, 0.6));
            border: 1px solid rgba(255,255,255,0.05);
            backdrop-filter: blur(10px);
        }

        .thought-trade {
            border-left: 3px solid #22c55e;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(24, 26, 42, 0.6));
        }

        .thought-error {
            border-left: 3px solid #ef4444;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(24, 26, 42, 0.6));
        }

        .thought-research {
            border-left: 3px solid #a855f7;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.08), rgba(24, 26, 42, 0.6));
        }

        .thought-system {
            border-left: 3px solid #3b82f6;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.06), rgba(24, 26, 42, 0.6));
        }

        .stat-card {
            background: linear-gradient(135deg, #1e2030, #181a2a);
            border: 1px solid rgba(255,255,255,0.06);
            transition: all 0.2s ease;
        }
        .stat-card:hover { border-color: rgba(255,255,255,0.12); }

        .holding-row { transition: all 0.15s ease; }
        .holding-row:hover { background: rgba(255,255,255,0.03); }

        .btn-primary {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            transition: all 0.2s ease;
        }
        .btn-primary:hover { 
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }

        .tab-active { color: #e2e8f0; border-bottom: 2px solid #3b82f6; }
        .tab-inactive { color: #64748b; border-bottom: 2px solid transparent; }
        .tab-inactive:hover { color: #94a3b8; }

        .modal-overlay {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
        }

        .profile-card {
            border: 2px solid rgba(255,255,255,0.06);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .profile-card:hover { border-color: rgba(255,255,255,0.15); }
        .profile-card.active { border-color: #3b82f6; box-shadow: 0 0 20px rgba(59, 130, 246, 0.2); }

        .mobile-nav-btn { transition: color 0.15s ease; }
        .mobile-nav-btn.active { color: #3b82f6; }
        .safe-bottom { padding-bottom: max(0.375rem, env(safe-area-inset-bottom)); }
        #thought-stream { -webkit-overflow-scrolling: touch; }

        @media (max-width: 767px) {
            .desktop-only { display: none !important; }
            #app { height: 100dvh; }
        }
        @media (min-width: 768px) {
            .mobile-only { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="app" class="flex flex-col h-screen">
        <!-- Header -->
        <header class="flex items-center justify-between px-3 md:px-6 py-2 md:py-3 border-b border-white/5 bg-dark-800/80 backdrop-blur-md sticky top-0 z-50">
            <div class="flex items-center gap-2 md:gap-3">
                <div class="w-7 h-7 md:w-8 md:h-8 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-sm font-bold shrink-0">
                    üß†
                </div>
                <div>
                    <h1 class="text-base md:text-lg font-semibold tracking-tight">StockMind</h1>
                    <p class="text-[9px] md:text-[10px] text-dark-300 uppercase tracking-widest hidden sm:block">AI Investor ‚Ä¢ Research Experiment</p>
                </div>
            </div>
            <div class="flex items-center gap-2 md:gap-4">
                <div id="market-status" class="flex items-center gap-1.5 md:gap-2 text-[10px] md:text-xs">
                    <span class="w-2 h-2 rounded-full bg-dark-400 pulse-dot"></span>
                    <span class="text-dark-300 hidden sm:inline">Loading...</span>
                </div>
                <a href="/about" class="text-[10px] md:text-xs text-dark-300 hover:text-dark-100 transition-colors hidden sm:inline">About</a>
                <div id="risk-badge" class="flex items-center gap-1 md:gap-1.5 text-[10px] md:text-xs px-1.5 md:px-2 py-1 rounded-md bg-dark-600 cursor-pointer" onclick="openSettings()">
                    <span id="risk-badge-icon">‚öñÔ∏è</span>
                    <span id="risk-badge-label" class="text-dark-200 font-medium hidden sm:inline">Moderate</span>
                </div>
                <div id="agent-status" class="items-center gap-2 text-xs text-dark-300 hidden md:flex desktop-only">
                    <span class="w-2 h-2 rounded-full bg-accent-green pulse-dot"></span>
                    <span id="next-check-label">Agent idle</span>
                </div>
                <button onclick="openSettings()" class="p-1.5 rounded-lg hover:bg-dark-600 transition-colors text-dark-300 hover:text-dark-100 hidden md:block desktop-only" title="Settings">
                    <svg class="w-4.5 h-4.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col md:flex-row overflow-hidden">
            <!-- Left Panel: Stats + Thought Stream -->
            <div id="mobile-panel-thoughts" class="flex-1 flex flex-col min-w-0 overflow-hidden">
                <!-- Stats Bar -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-2 md:gap-3 p-3 md:p-4 pb-2">
                    <div class="stat-card rounded-xl p-2.5 md:p-3">
                        <p class="text-[9px] md:text-[10px] uppercase tracking-wider text-dark-300 mb-0.5 md:mb-1">Portfolio Value</p>
                        <p id="stat-total" class="text-base md:text-xl font-semibold font-mono">$100,000.00</p>
                        <div class="mt-1 h-6 md:h-8"><canvas id="sparkline-chart"></canvas></div>
                    </div>
                    <div class="stat-card rounded-xl p-2.5 md:p-3">
                        <p class="text-[9px] md:text-[10px] uppercase tracking-wider text-dark-300 mb-0.5 md:mb-1">Cash</p>
                        <p id="stat-cash" class="text-base md:text-xl font-semibold font-mono text-accent-cyan">$100,000.00</p>
                    </div>
                    <div class="stat-card rounded-xl p-2.5 md:p-3">
                        <p class="text-[9px] md:text-[10px] uppercase tracking-wider text-dark-300 mb-0.5 md:mb-1">Total P&L</p>
                        <p id="stat-pnl" class="text-base md:text-xl font-semibold font-mono">$0.00</p>
                    </div>
                    <div class="stat-card rounded-xl p-2.5 md:p-3">
                        <p class="text-[9px] md:text-[10px] uppercase tracking-wider text-dark-300 mb-0.5 md:mb-1">Total Trades</p>
                        <p id="stat-trades" class="text-base md:text-xl font-semibold font-mono text-accent-purple">0</p>
                    </div>
                </div>

                <!-- Thought Stream -->
                <div class="flex-1 flex flex-col min-h-0 px-3 md:px-4 pb-2 md:pb-4">
                    <div class="flex items-center justify-between mb-2 shrink-0">
                        <h2 class="text-xs md:text-sm font-medium text-dark-200 flex items-center gap-2">
                            <svg class="w-4 h-4 text-accent-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                            StockMind's Thoughts
                        </h2>
                        <span class="text-[10px] text-dark-400" id="thought-count">0 thoughts</span>
                    </div>
                    <div id="thought-stream" class="flex-1 overflow-y-auto space-y-2 pr-1 min-h-0 -webkit-overflow-scrolling-touch">
                        <div class="flex items-center justify-center h-32 text-dark-400 text-sm">
                            <div class="text-center">
                                <div class="text-2xl mb-2">üß†</div>
                                <p>StockMind is waking up...</p>
                                <p class="text-xs text-dark-500 mt-1">Thoughts will appear here as the AI thinks</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Portfolio & Info (hidden on mobile, shown via bottom nav) -->
            <div id="mobile-panel-data" class="hidden md:flex w-full md:w-[420px] border-t md:border-t-0 md:border-l border-white/5 flex-col bg-dark-800/30 overflow-hidden">
                <!-- Tabs -->
                <div class="flex border-b border-white/5 px-3 md:px-4 overflow-x-auto">
                    <button onclick="switchTab('portfolio')" id="tab-portfolio" class="tab-active px-2.5 md:px-3 py-2.5 text-[11px] md:text-xs font-medium whitespace-nowrap">
                        Portfolio
                    </button>
                    <button onclick="switchTab('performance')" id="tab-performance" class="tab-inactive px-2.5 md:px-3 py-2.5 text-[11px] md:text-xs font-medium whitespace-nowrap">
                        Performance
                    </button>
                    <button onclick="switchTab('trades')" id="tab-trades" class="tab-inactive px-2.5 md:px-3 py-2.5 text-[11px] md:text-xs font-medium whitespace-nowrap">
                        Trades
                    </button>
                    <button onclick="switchTab('market')" id="tab-market" class="tab-inactive px-2.5 md:px-3 py-2.5 text-[11px] md:text-xs font-medium whitespace-nowrap">
                        Market
                    </button>
                </div>

                <!-- Tab Content -->
                <div class="flex-1 overflow-y-auto">
                    <!-- Portfolio Tab -->
                    <div id="panel-portfolio" class="p-3 md:p-4">
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-3">
                                <h3 class="text-xs font-medium uppercase tracking-wider text-dark-300">Holdings</h3>
                                <span id="holdings-count" class="text-[10px] text-dark-400">0 positions</span>
                            </div>
                            <div id="holdings-list" class="space-y-1">
                                <p class="text-xs text-dark-400 text-center py-6">No holdings yet.<br>The AI will start investing soon!</p>
                            </div>
                        </div>

                        <div>
                            <h3 class="text-xs font-medium uppercase tracking-wider text-dark-300 mb-3">Allocation</h3>
                            <div class="flex justify-center mb-3">
                                <div class="w-40 h-40 md:w-48 md:h-48"><canvas id="allocation-donut"></canvas></div>
                            </div>
                            <div id="allocation-legend" class="flex flex-wrap gap-2 md:gap-3 text-[10px] text-dark-300">
                                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-accent-cyan"></span> Cash 100%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Tab -->
                    <div id="panel-performance" class="p-3 md:p-4 hidden">
                        <h3 class="text-xs font-medium uppercase tracking-wider text-dark-300 mb-3">Portfolio Value Over Time</h3>
                        <div class="gradient-border rounded-xl p-2 md:p-3 mb-4">
                            <canvas id="portfolio-value-chart" height="200"></canvas>
                        </div>

                        <h3 class="text-xs font-medium uppercase tracking-wider text-dark-300 mb-3">P&L Over Time</h3>
                        <div class="gradient-border rounded-xl p-2 md:p-3">
                            <canvas id="pnl-chart" height="180"></canvas>
                        </div>
                    </div>

                    <!-- Trades Tab -->
                    <div id="panel-trades" class="p-3 md:p-4 hidden">
                        <div id="trades-list" class="space-y-2">
                            <p class="text-xs text-dark-400 text-center py-6">No trades yet.</p>
                        </div>
                    </div>

                    <!-- Market Tab -->
                    <div id="panel-market" class="p-3 md:p-4 hidden">
                        <h3 class="text-xs font-medium uppercase tracking-wider text-dark-300 mb-3">Market Overview</h3>
                        <div id="market-overview" class="space-y-2 mb-6">
                            <p class="text-xs text-dark-400">Loading...</p>
                        </div>

                        <h3 class="text-xs font-medium uppercase tracking-wider text-dark-300 mb-3">Watchlist</h3>
                        <div id="watchlist" class="space-y-1">
                            <p class="text-xs text-dark-400">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Bottom Navigation -->
        <nav class="mobile-only flex items-center justify-around border-t border-white/5 bg-dark-800/90 backdrop-blur-md px-2 py-1.5 safe-bottom">
            <button onclick="switchMobilePanel('thoughts')" id="mobile-nav-thoughts" class="mobile-nav-btn active flex flex-col items-center gap-0.5 px-3 py-1 text-dark-300">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                <span class="text-[9px] font-medium">Thoughts</span>
            </button>
            <button onclick="switchMobilePanel('data'); switchTab('portfolio')" id="mobile-nav-portfolio" class="mobile-nav-btn flex flex-col items-center gap-0.5 px-3 py-1 text-dark-300">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/></svg>
                <span class="text-[9px] font-medium">Portfolio</span>
            </button>
            <button onclick="switchMobilePanel('data'); switchTab('performance')" id="mobile-nav-charts" class="mobile-nav-btn flex flex-col items-center gap-0.5 px-3 py-1 text-dark-300">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                <span class="text-[9px] font-medium">Charts</span>
            </button>
            <button onclick="switchMobilePanel('data'); switchTab('market')" id="mobile-nav-market" class="mobile-nav-btn flex flex-col items-center gap-0.5 px-3 py-1 text-dark-300">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                <span class="text-[9px] font-medium">Market</span>
            </button>
            <button onclick="openSettings()" id="mobile-nav-settings" class="mobile-nav-btn flex flex-col items-center gap-0.5 px-3 py-1 text-dark-300">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.066 2.573c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.573 1.066c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.066-2.573c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                <span class="text-[9px] font-medium">Settings</span>
            </button>
        </nav>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[100] hidden">
        <div class="modal-overlay absolute inset-0" onclick="closeSettings()"></div>
        <div class="absolute inset-0 flex items-end md:items-center justify-center md:p-8 pointer-events-none">
            <div class="gradient-border rounded-t-2xl md:rounded-2xl w-full max-w-lg pointer-events-auto max-h-[85vh] overflow-y-auto" style="background: #12141f;">
                <div class="flex items-center justify-between px-4 md:px-6 py-3 md:py-4 border-b border-white/5 sticky top-0 z-10" style="background: #12141f;">
                    <h2 class="text-sm md:text-base font-semibold">Settings</h2>
                    <button onclick="closeSettings()" class="text-dark-400 hover:text-dark-100 transition-colors p-1">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="p-4 md:p-6">
                    <h3 class="text-xs font-medium uppercase tracking-wider text-dark-300 mb-3 md:mb-4">Risk Profile</h3>
                    <div class="grid grid-cols-3 gap-2 md:gap-3 mb-4 md:mb-6">
                        <div id="profile-safe" class="profile-card rounded-xl p-3 md:p-4 gradient-border" style="cursor: default;">
                            <div class="text-xl md:text-2xl mb-1 md:mb-2">üõ°Ô∏è</div>
                            <h4 class="text-xs md:text-sm font-semibold mb-0.5 md:mb-1">Safe</h4>
                            <p class="text-[9px] md:text-[10px] text-dark-300 leading-relaxed">Capital preservation. Blue-chip, low volatility.</p>
                        </div>
                        <div id="profile-moderate" class="profile-card rounded-xl p-3 md:p-4 gradient-border" style="cursor: default;">
                            <div class="text-xl md:text-2xl mb-1 md:mb-2">‚öñÔ∏è</div>
                            <h4 class="text-xs md:text-sm font-semibold mb-0.5 md:mb-1">Moderate</h4>
                            <p class="text-[9px] md:text-[10px] text-dark-300 leading-relaxed">Balanced growth. Value and momentum mix.</p>
                        </div>
                        <div id="profile-aggressive" class="profile-card rounded-xl p-3 md:p-4 gradient-border" style="cursor: default;">
                            <div class="text-xl md:text-2xl mb-1 md:mb-2">üî•</div>
                            <h4 class="text-xs md:text-sm font-semibold mb-0.5 md:mb-1">Aggressive</h4>
                            <p class="text-[9px] md:text-[10px] text-dark-300 leading-relaxed">High growth. Concentrated bets, momentum.</p>
                        </div>
                    </div>

                    <div id="profile-details" class="gradient-border rounded-xl p-3 md:p-4">
                        <h4 class="text-xs font-medium uppercase tracking-wider text-dark-300 mb-2 md:mb-3">Active Limits</h4>
                        <div class="grid grid-cols-3 gap-3 md:gap-4 text-center">
                            <div>
                                <p id="limit-position" class="text-base md:text-lg font-semibold font-mono text-accent-blue">20%</p>
                                <p class="text-[9px] md:text-[10px] text-dark-400 mt-0.5">Max Per Stock</p>
                            </div>
                            <div>
                                <p id="limit-cash" class="text-base md:text-lg font-semibold font-mono text-accent-cyan">15%</p>
                                <p class="text-[9px] md:text-[10px] text-dark-400 mt-0.5">Min Cash</p>
                            </div>
                            <div>
                                <p id="limit-holdings" class="text-base md:text-lg font-semibold font-mono text-accent-purple">10</p>
                                <p class="text-[9px] md:text-[10px] text-dark-400 mt-0.5">Max Holdings</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ‚îÄ‚îÄ‚îÄ State ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let thoughts = [];
        let lastThoughtId = 0;
        let currentTab = 'portfolio';
        let eventSource = null;
        let currentRiskProfile = 'moderate';
        let sparklineChart = null;
        let portfolioValueChart = null;
        let pnlChart = null;
        let allocationDonut = null;

        // ‚îÄ‚îÄ‚îÄ Formatting Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function fmt(n, decimals = 2) {
            return new Intl.NumberFormat('en-US', { 
                minimumFractionDigits: decimals, 
                maximumFractionDigits: decimals 
            }).format(n);
        }

        function fmtMoney(n) {
            const abs = Math.abs(n);
            if (abs >= 1e12) return '$' + fmt(n / 1e12, 1) + 'T';
            if (abs >= 1e9) return '$' + fmt(n / 1e9, 1) + 'B';
            if (abs >= 1e6) return '$' + fmt(n / 1e6, 1) + 'M';
            return '$' + fmt(n);
        }

        function pnlClass(n) { return n >= 0 ? 'text-accent-green' : 'text-accent-red'; }
        function pnlSign(n) { return n >= 0 ? '+' : ''; }

        function timeAgo(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);
            if (diff < 60) return 'just now';
            if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ‚îÄ‚îÄ‚îÄ Chart.js Defaults ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
        Chart.defaults.font.family = "'Inter', sans-serif";
        Chart.defaults.font.size = 10;

        // ‚îÄ‚îÄ‚îÄ Mobile Panel Switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let currentMobilePanel = 'thoughts';

        function switchMobilePanel(panel) {
            currentMobilePanel = panel;
            const thoughtsPanel = document.getElementById('mobile-panel-thoughts');
            const dataPanel = document.getElementById('mobile-panel-data');

            if (panel === 'thoughts') {
                thoughtsPanel.classList.remove('hidden');
                thoughtsPanel.classList.add('flex');
                dataPanel.classList.add('hidden');
                dataPanel.classList.remove('flex');
            } else {
                thoughtsPanel.classList.add('hidden');
                thoughtsPanel.classList.remove('flex');
                dataPanel.classList.remove('hidden');
                dataPanel.classList.add('flex');
            }

            // Update bottom nav active states
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => btn.classList.remove('active'));
            if (panel === 'thoughts') {
                document.getElementById('mobile-nav-thoughts').classList.add('active');
            } else {
                const navMap = { portfolio: 'mobile-nav-portfolio', performance: 'mobile-nav-charts', trades: 'mobile-nav-portfolio', market: 'mobile-nav-market' };
                const activeNav = document.getElementById(navMap[currentTab] || 'mobile-nav-portfolio');
                if (activeNav) activeNav.classList.add('active');
            }
        }

        // ‚îÄ‚îÄ‚îÄ Tab Switching ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function switchTab(tab) {
            currentTab = tab;
            ['portfolio', 'performance', 'trades', 'market'].forEach(t => {
                const tabBtn = document.getElementById(`tab-${t}`);
                tabBtn.className = t === tab
                    ? 'tab-active px-2.5 md:px-3 py-2.5 text-[11px] md:text-xs font-medium whitespace-nowrap'
                    : 'tab-inactive px-2.5 md:px-3 py-2.5 text-[11px] md:text-xs font-medium whitespace-nowrap';
                document.getElementById(`panel-${t}`).classList.toggle('hidden', t !== tab);
            });
            if (tab === 'trades') loadTrades();
            if (tab === 'market') loadMarket();
            if (tab === 'performance') loadPerformanceCharts();

            // Update mobile nav highlight
            document.querySelectorAll('.mobile-nav-btn').forEach(btn => btn.classList.remove('active'));
            const navMap = { portfolio: 'mobile-nav-portfolio', performance: 'mobile-nav-charts', trades: 'mobile-nav-portfolio', market: 'mobile-nav-market' };
            const activeNav = document.getElementById(navMap[tab] || 'mobile-nav-portfolio');
            if (activeNav) activeNav.classList.add('active');
        }

        // ‚îÄ‚îÄ‚îÄ Thought Stream ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function addThought(thought, skipAnimation = false) {
            const stream = document.getElementById('thought-stream');
            if (thoughts.length === 0) stream.innerHTML = '';

            const typeClass = {
                'thinking': 'thought-bubble', 'trade': 'thought-trade',
                'error': 'thought-error', 'research': 'thought-research',
                'system': 'thought-system',
            }[thought.type] || 'thought-bubble';

            const typeIcon = {
                'thinking': 'üí≠', 'trade': 'üí∞', 'error': '‚ö†Ô∏è',
                'research': 'üîç', 'system': '‚öôÔ∏è',
            }[thought.type] || 'üí≠';

            const div = document.createElement('div');
            div.className = `${typeClass} rounded-lg px-3 md:px-4 py-2.5 md:py-3${skipAnimation ? '' : ' thought-enter'}`;
            div.innerHTML = `
                <div class="flex items-start gap-2">
                    <span class="text-sm mt-0.5 shrink-0">${typeIcon}</span>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm leading-relaxed text-dark-100">${escapeHtml(thought.content)}</p>
                        <p class="text-[10px] text-dark-400 mt-1.5">${timeAgo(thought.created_at)}</p>
                    </div>
                </div>
            `;
            stream.appendChild(div);
            thoughts.push(thought);
            if (!skipAnimation) stream.scrollTop = stream.scrollHeight;
            document.getElementById('thought-count').textContent = `${thoughts.length} thoughts`;
        }

        // ‚îÄ‚îÄ‚îÄ SSE Connection ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        let sseReady = false;

        function connectSSE() {
            if (eventSource) eventSource.close();
            eventSource = new EventSource('/api/stream');
            eventSource.addEventListener('thought', (e) => {
                if (!sseReady) return;
                const thought = JSON.parse(e.data);
                if (thought.id > lastThoughtId) {
                    lastThoughtId = thought.id;
                    addThought(thought);
                }
            });
            eventSource.onopen = () => {
                setTimeout(() => { sseReady = true; }, 3000);
            };
            eventSource.onerror = () => {
                sseReady = false;
                console.log('SSE connection lost, reconnecting...');
                setTimeout(connectSSE, 10000);
            };
        }

        // ‚îÄ‚îÄ‚îÄ Sparkline ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function updateSparkline(snapshots) {
            const ctx = document.getElementById('sparkline-chart').getContext('2d');
            if (sparklineChart) sparklineChart.destroy();
            if (!snapshots || snapshots.length < 2) return;

            const values = snapshots.map(s => s.total_value);
            const trend = values[values.length - 1] >= values[0];

            sparklineChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: snapshots.map(() => ''),
                    datasets: [{
                        data: values,
                        borderColor: trend ? '#22c55e' : '#ef4444',
                        backgroundColor: trend ? 'rgba(34,197,94,0.1)' : 'rgba(239,68,68,0.1)',
                        borderWidth: 1.5,
                        fill: true,
                        pointRadius: 0,
                        tension: 0.4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { enabled: false } },
                    scales: {
                        x: { display: false },
                        y: { display: false },
                    },
                }
            });
        }

        // ‚îÄ‚îÄ‚îÄ Performance Charts ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadPerformanceCharts() {
            try {
                const res = await fetch('/api/portfolio/history?days=30');
                const data = await res.json();
                const snapshots = data.snapshots || [];

                renderPortfolioValueChart(snapshots);
                renderPnlChart(snapshots);
            } catch (e) {
                console.error('Performance chart error:', e);
            }
        }

        function renderPortfolioValueChart(snapshots) {
            const ctx = document.getElementById('portfolio-value-chart').getContext('2d');
            if (portfolioValueChart) portfolioValueChart.destroy();

            if (snapshots.length === 0) {
                portfolioValueChart = null;
                return;
            }

            const labels = snapshots.map(s => {
                const d = new Date(s.created_at);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' + d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            });
            const values = snapshots.map(s => s.total_value);
            const startingBalance = 100000;

            portfolioValueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Portfolio Value',
                            data: values,
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59,130,246,0.1)',
                            borderWidth: 2,
                            fill: true,
                            pointRadius: snapshots.length > 30 ? 0 : 3,
                            pointBackgroundColor: '#3b82f6',
                            tension: 0.3,
                        },
                        {
                            label: 'Starting Balance',
                            data: values.map(() => startingBalance),
                            borderColor: 'rgba(148,163,184,0.3)',
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            fill: false,
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: true, position: 'top', labels: { boxWidth: 12, padding: 15, font: { size: 10 } } },
                        tooltip: {
                            backgroundColor: '#1e2030',
                            titleColor: '#e2e8f0',
                            bodyColor: '#94a3b8',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            padding: 10,
                            callbacks: {
                                label: ctx => ctx.dataset.label + ': $' + fmt(ctx.parsed.y),
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { maxTicksLimit: 8, font: { size: 9 } },
                            grid: { display: false },
                        },
                        y: {
                            ticks: {
                                callback: v => '$' + (v >= 1000 ? fmt(v/1000, 1) + 'k' : fmt(v, 0)),
                                font: { size: 9 },
                            },
                            grid: { color: 'rgba(255,255,255,0.03)' },
                        }
                    }
                }
            });
        }

        function renderPnlChart(snapshots) {
            const ctx = document.getElementById('pnl-chart').getContext('2d');
            if (pnlChart) pnlChart.destroy();

            if (snapshots.length === 0) { pnlChart = null; return; }

            const labels = snapshots.map(s => {
                const d = new Date(s.created_at);
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) + ' ' + d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            });
            const pnlValues = snapshots.map(s => s.pnl);
            const colors = pnlValues.map(v => v >= 0 ? 'rgba(34,197,94,0.7)' : 'rgba(239,68,68,0.7)');

            pnlChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'P&L',
                        data: pnlValues,
                        backgroundColor: colors,
                        borderRadius: 3,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1e2030',
                            titleColor: '#e2e8f0',
                            bodyColor: '#94a3b8',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            padding: 10,
                            callbacks: {
                                label: ctx => 'P&L: ' + (ctx.parsed.y >= 0 ? '+' : '') + '$' + fmt(ctx.parsed.y),
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { maxTicksLimit: 8, font: { size: 9 } },
                            grid: { display: false },
                        },
                        y: {
                            ticks: {
                                callback: v => (v >= 0 ? '+' : '') + '$' + fmt(v, 0),
                                font: { size: 9 },
                            },
                            grid: { color: 'rgba(255,255,255,0.03)' },
                        }
                    }
                }
            });
        }

        // ‚îÄ‚îÄ‚îÄ Data Loading ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadPortfolio() {
            try {
                const res = await fetch('/api/portfolio');
                const data = await res.json();

                document.getElementById('stat-total').textContent = '$' + fmt(data.total_value);
                document.getElementById('stat-cash').textContent = '$' + fmt(data.cash);
                
                const pnlEl = document.getElementById('stat-pnl');
                pnlEl.textContent = pnlSign(data.total_pnl) + '$' + fmt(Math.abs(data.total_pnl));
                pnlEl.className = `text-base md:text-xl font-semibold font-mono ${pnlClass(data.total_pnl)}`;

                const list = document.getElementById('holdings-list');
                const count = document.getElementById('holdings-count');

                if (data.holdings.length === 0) {
                    list.innerHTML = '<p class="text-xs text-dark-400 text-center py-6">No holdings yet.<br>The AI will start investing soon!</p>';
                    count.textContent = '0 positions';
                } else {
                    count.textContent = `${data.holdings.length} position${data.holdings.length > 1 ? 's' : ''}`;
                    list.innerHTML = data.holdings.map(h => `
                        <div class="holding-row rounded-lg px-3 py-2.5 gradient-border">
                            <div class="flex items-center justify-between mb-1">
                                <span class="font-semibold text-sm">${h.symbol}</span>
                                <span class="font-mono text-sm">${fmtMoney(h.market_value)}</span>
                            </div>
                            <div class="flex items-center justify-between text-[11px]">
                                <span class="text-dark-300">${h.shares} shares @ $${fmt(h.avg_cost)}</span>
                                <span class="${pnlClass(h.pnl)} font-mono">
                                    ${pnlSign(h.pnl)}$${fmt(Math.abs(h.pnl))} (${pnlSign(h.pnl_pct)}${fmt(Math.abs(h.pnl_pct), 1)}%)
                                </span>
                            </div>
                            <div class="flex items-center justify-between text-[10px] mt-1">
                                <span class="text-dark-400">Now: $${fmt(h.current_price)}</span>
                                <span class="${pnlClass(h.day_change_pct)} text-dark-300">
                                    Today: ${pnlSign(h.day_change_pct)}${fmt(Math.abs(h.day_change_pct), 1)}%
                                </span>
                            </div>
                        </div>
                    `).join('');
                }

                updateAllocationDonut(data);

            } catch (e) {
                console.error('Portfolio load error:', e);
            }
        }

        function updateAllocationDonut(data) {
            const ctx = document.getElementById('allocation-donut').getContext('2d');
            const legend = document.getElementById('allocation-legend');
            
            if (data.total_value <= 0) return;

            const cashPct = (data.cash / data.total_value * 100);
            const holdingColors = ['#f59e0b', '#a855f7', '#22c55e', '#ef4444', '#06b6d4', '#3b82f6', '#ec4899', '#84cc16'];

            const labels = ['Cash'];
            const values = [cashPct];
            const colors = ['#06b6d4'];

            data.holdings.forEach((h, i) => {
                const pct = (h.market_value / data.total_value * 100);
                labels.push(h.symbol);
                values.push(pct);
                colors.push(holdingColors[i % holdingColors.length]);
            });

            if (allocationDonut) allocationDonut.destroy();

            allocationDonut = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels,
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderColor: '#12141f',
                        borderWidth: 2,
                        hoverOffset: 6,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '65%',
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1e2030',
                            titleColor: '#e2e8f0',
                            bodyColor: '#94a3b8',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            padding: 10,
                            callbacks: {
                                label: ctx => ctx.label + ': ' + fmt(ctx.parsed, 1) + '%',
                            }
                        }
                    }
                }
            });

            legend.innerHTML = labels.map((l, i) =>
                `<span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full" style="background:${colors[i]}"></span> ${l} ${fmt(values[i], 0)}%</span>`
            ).join('');
        }

        async function loadTrades() {
            try {
                const res = await fetch('/api/trades');
                const data = await res.json();
                const list = document.getElementById('trades-list');
                const tradeCount = document.getElementById('stat-trades');
                
                tradeCount.textContent = data.trades.length.toString();

                if (data.trades.length === 0) {
                    list.innerHTML = '<p class="text-xs text-dark-400 text-center py-6">No trades yet.</p>';
                    return;
                }

                list.innerHTML = data.trades.map(t => `
                    <div class="gradient-border rounded-lg px-3 py-2.5">
                        <div class="flex items-center justify-between mb-1">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-medium px-1.5 py-0.5 rounded ${t.action === 'buy' ? 'bg-accent-green/20 text-accent-green' : 'bg-accent-red/20 text-accent-red'}">
                                    ${t.action.toUpperCase()}
                                </span>
                                <span class="font-semibold text-sm">${t.symbol}</span>
                            </div>
                            <span class="text-[10px] text-dark-400">${timeAgo(t.created_at)}</span>
                        </div>
                        <div class="flex items-center justify-between text-[11px] text-dark-300">
                            <span>${t.shares} shares @ $${fmt(t.price)}</span>
                            <span class="font-mono">$${fmt(t.total)}</span>
                        </div>
                        ${t.reasoning ? `<p class="text-[10px] text-dark-400 mt-1 italic">"${escapeHtml(t.reasoning)}"</p>` : ''}
                    </div>
                `).join('');
            } catch (e) {
                console.error('Trades load error:', e);
            }
        }

        async function loadMarket() {
            try {
                const [marketRes, watchRes] = await Promise.all([
                    fetch('/api/market'),
                    fetch('/api/watchlist')
                ]);
                const marketData = await marketRes.json();
                const watchData = await watchRes.json();

                const overview = document.getElementById('market-overview');
                if (marketData.overview && Object.keys(marketData.overview).length > 0) {
                    overview.innerHTML = Object.entries(marketData.overview).map(([name, data]) => `
                        <div class="gradient-border rounded-lg px-3 py-2 flex items-center justify-between">
                            <span class="text-xs font-medium">${name}</span>
                            <div class="text-right">
                                <span class="text-xs font-mono">${fmt(data.value)}</span>
                                <span class="text-[10px] font-mono ${pnlClass(data.change_pct)} ml-2">
                                    ${pnlSign(data.change_pct)}${fmt(Math.abs(data.change_pct), 2)}%
                                </span>
                            </div>
                        </div>
                    `).join('');
                } else {
                    overview.innerHTML = '<p class="text-xs text-dark-400">Market data unavailable</p>';
                }

                const statusEl = document.getElementById('market-status');
                const isOpen = marketData.market_open;
                statusEl.innerHTML = `
                    <span class="w-2 h-2 rounded-full ${isOpen ? 'bg-accent-green' : 'bg-accent-red'} pulse-dot"></span>
                    <span class="text-dark-300 hidden sm:inline">Market ${isOpen ? 'Open' : 'Closed'}</span>
                `;

                const watchlist = document.getElementById('watchlist');
                if (watchData.quotes && Object.keys(watchData.quotes).length > 0) {
                    watchlist.innerHTML = Object.entries(watchData.quotes)
                        .sort((a, b) => a[0].localeCompare(b[0]))
                        .map(([sym, q]) => `
                            <div class="gradient-border rounded-lg px-3 py-2 flex items-center justify-between holding-row">
                                <span class="text-xs font-semibold">${sym}</span>
                                <div class="text-right">
                                    <span class="text-xs font-mono">$${fmt(q.price)}</span>
                                    <span class="text-[10px] font-mono ${pnlClass(q.change_pct)} ml-2">
                                        ${pnlSign(q.change_pct)}${fmt(Math.abs(q.change_pct), 2)}%
                                    </span>
                                </div>
                            </div>
                        `).join('');
                } else {
                    watchlist.innerHTML = '<p class="text-xs text-dark-400">Loading watchlist...</p>';
                }
            } catch (e) {
                console.error('Market load error:', e);
            }
        }

        async function loadInitialThoughts() {
            try {
                const res = await fetch('/api/thoughts?limit=30');
                const data = await res.json();
                if (data.thoughts && data.thoughts.length > 0) {
                    const sorted = data.thoughts.reverse();
                    document.getElementById('thought-stream').innerHTML = '';
                    sorted.forEach(t => {
                        lastThoughtId = Math.max(lastThoughtId, t.id);
                        addThought(t, true);
                    });
                }
            } catch (e) {
                console.error('Initial thoughts load error:', e);
            }
        }

        // ‚îÄ‚îÄ‚îÄ Settings ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadSettings() {
            try {
                const res = await fetch('/api/settings');
                const data = await res.json();
                currentRiskProfile = data.risk_profile || 'moderate';
                updateSettingsUI(data.risk_profile, data.limits);
            } catch (e) {
                console.error('Settings load error:', e);
            }
        }

        function updateSettingsUI(profile, limits) {
            ['safe', 'moderate', 'aggressive'].forEach(p => {
                const el = document.getElementById(`profile-${p}`);
                el.classList.toggle('active', p === profile);
            });

            if (limits) {
                document.getElementById('limit-position').textContent = limits.max_position_pct + '%';
                document.getElementById('limit-cash').textContent = limits.min_cash_pct + '%';
                document.getElementById('limit-holdings').textContent = limits.max_holdings;
            }

            const badgeIcons = { safe: 'üõ°Ô∏è', moderate: '‚öñÔ∏è', aggressive: 'üî•' };
            const badgeLabels = { safe: 'Safe', moderate: 'Moderate', aggressive: 'Aggressive' };
            document.getElementById('risk-badge-icon').textContent = badgeIcons[profile] || '‚öñÔ∏è';
            document.getElementById('risk-badge-label').textContent = badgeLabels[profile] || 'Moderate';
        }

        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }

        // ‚îÄ‚îÄ‚îÄ Actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function triggerCycle() {
            try {
                await fetch('/api/trigger', { method: 'POST' });
            } catch (e) {
                console.error('Trigger error:', e);
            }
        }

        // ‚îÄ‚îÄ‚îÄ Agent Status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadStatus() {
            try {
                const res = await fetch('/api/status');
                const data = await res.json();
                const label = document.getElementById('next-check-label');

                if (data.next_check) {
                    const next = new Date(data.next_check);
                    const now = new Date();
                    const diffMin = Math.max(0, Math.round((next - now) / 60000));
                    const session = data.next_session || 'Check-in';

                    if (diffMin < 1) {
                        label.textContent = `${session} ‚Äî any moment now...`;
                    } else if (diffMin < 60) {
                        label.textContent = `${session} in ${diffMin}m`;
                    } else {
                        const timeStr = next.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                        label.textContent = `${session} ~${timeStr}`;
                    }
                } else if (data.last_cycle) {
                    label.textContent = `Last check: ${timeAgo(data.last_cycle)}`;
                } else {
                    label.textContent = 'Agent starting...';
                }
            } catch (e) {
                console.error('Status load error:', e);
            }
        }

        // ‚îÄ‚îÄ‚îÄ Sparkline Loader ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function loadSparkline() {
            try {
                const res = await fetch('/api/portfolio/history?days=7');
                const data = await res.json();
                updateSparkline(data.snapshots || []);
            } catch (e) {
                console.error('Sparkline error:', e);
            }
        }

        // ‚îÄ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        async function init() {
            await loadInitialThoughts();
            await loadPortfolio();
            await loadTrades();
            await loadStatus();
            await loadSettings();
            await loadSparkline();
            connectSSE();

            setInterval(loadPortfolio, 60000);
            setInterval(loadTrades, 120000);
            setInterval(loadStatus, 60000);
            setInterval(loadSparkline, 300000);
        }

        init();
    </script>
</body>
</html>
